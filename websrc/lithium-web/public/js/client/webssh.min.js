var jQuery,wssh={};!function(){var proto=FormData.prototype,data={};proto.get||(proto.get=function(name){if(void 0===data[name]){var input=document.querySelector('input[name="'+name+'"]'),value;input&&(value="file"===input.type?input.files[0]:input.value,data[name]=value)}return data[name]}),proto.set||(proto.set=function(name,value){data[name]=value})}(),jQuery((function($){var status=$("#status"),button=$(".btn-primary"),form_container=$(".form-container"),waiter=$("#waiter"),term_type=$("#term"),style={},default_title="WebSSH",title_element=document.querySelector("title"),form_id="#connect",debug=document.querySelector(form_id).noValidate,custom_font=document.fonts?document.fonts.values().next().value:void 0,default_fonts,DISCONNECTED=0,CONNECTING=1,CONNECTED=2,state=0,messages={1:"This client is connecting ...",2:"This client is already connnected."},key_max_size=16384,fields=["hostname","port","username"],form_keys=fields.concat(["password","totp"]),opts_keys=["bgcolor","title","encoding","command","term","fontsize","fontcolor"],url_form_data={},url_opts_data={},validated_form_data,event_origin,hostname_tester=/((^\s*((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))\s*$)|(^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$))|(^\s*((?=.{1,255}$)(?=.*[A-Za-z].*)[0-9A-Za-z](?:(?:[0-9A-Za-z]|\b-){0,61}[0-9A-Za-z])?(?:\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|\b-){0,61}[0-9A-Za-z])?)*)\s*$)/;function store_items(names,data){var i,name,value;for(i=0;i<names.length;i++)name=names[i],(value=data.get(name))&&window.localStorage.setItem(name,value)}function restore_items(names){var i,name,value;for(i=0;i<names.length;i++)name=names[i],(value=window.localStorage.getItem(name))&&$("#"+name).val(value)}function populate_form(data){var names=form_keys.concat(["passphrase"]),i,name;for(i=0;i<names.length;i++)name=names[i],$("#"+name).val(data.get(name))}function get_object_length(object){return Object.keys(object).length}function decode_uri_component(uri){try{return decodeURIComponent(uri)}catch(e){console.error(e)}return""}function decode_password(encoded){try{return window.atob(encoded)}catch(e){console.error(e)}return null}function parse_url_data(string,form_keys,opts_keys,form_map,opts_map){var i,pair,key,val,arr=string.split("&");for(i=0;i<arr.length;i++)key=(pair=arr[i].split("="))[0].trim().toLowerCase(),val=pair.slice(1).join("=").trim(),form_keys.indexOf(key)>=0?form_map[key]=val:opts_keys.indexOf(key)>=0&&(opts_map[key]=val);form_map.password&&(form_map.password=decode_password(form_map.password))}function parse_xterm_style(){var text=$(".xterm-helpers style").text(),arr=text.split("xterm-normal-char{width:");style.width=parseFloat(arr[1]),arr=text.split("div{height:"),style.height=parseFloat(arr[1])}function get_cell_size(term){style.width=term._core._renderService._renderer.dimensions.actualCellWidth,style.height=term._core._renderService._renderer.dimensions.actualCellHeight}function toggle_fullscreen(term){$("#terminal .terminal").toggleClass("fullscreen"),term.fitAddon.fit()}function current_geometry(term){if(!style.width||!style.height)try{get_cell_size(term)}catch(TypeError){parse_xterm_style()}var cols,rows;return{cols:parseInt(window.innerWidth/style.width,10)-1,rows:parseInt(window.innerHeight/style.height,10)}}function resize_terminal(term){var geometry=current_geometry(term);term.on_resize(geometry.cols,geometry.rows)}function set_backgound_color(term,color){term.setOption("theme",{background:color})}function set_font_color(term,color){term.setOption("theme",{foreground:color})}function custom_font_is_loaded(){if(custom_font){if(console.log("Status of custom font "+custom_font.family+": "+custom_font.status),"loaded"===custom_font.status)return!0;if("unloaded"===custom_font.status)return!1}else console.log("No custom font specified.")}function update_font_family(term){if(term.font_family_updated)console.log("Already using custom font family");else if(default_fonts||(default_fonts=term.getOption("fontFamily")),custom_font_is_loaded()){var new_fonts=custom_font.family+", "+default_fonts;term.font_family_updated=!0,console.log("Using custom font family "+new_fonts)}}function reset_font_family(term){term.font_family_updated?default_fonts&&(term.setOption("fontFamily",default_fonts),term.font_family_updated=!1,console.log("Using default font family "+default_fonts)):console.log("Already using default font family")}function format_geometry(cols,rows){return JSON.stringify({cols:cols,rows:rows})}function read_as_text_with_decoder(file,callback,decoder){var reader=new window.FileReader;void 0===decoder&&(decoder=new window.TextDecoder("utf-8",{fatal:!0})),reader.onload=function(){var text;try{text=decoder.decode(reader.result)}catch(TypeError){console.log("Decoding error happened.")}finally{callback&&callback(text)}},reader.onerror=function(e){console.error(e)},reader.readAsArrayBuffer(file)}function read_as_text_with_encoding(file,callback,encoding){var reader=new window.FileReader;void 0===encoding&&(encoding="utf-8"),reader.onload=function(){callback&&callback(reader.result)},reader.onerror=function(e){console.error(e)},reader.readAsText(file,encoding)}function read_file_as_text(file,callback,decoder){window.TextDecoder?read_as_text_with_decoder(file,callback,decoder):read_as_text_with_encoding(file,callback,decoder)}function reset_wssh(){var name;for(name in wssh)wssh.hasOwnProperty(name)&&"connect"!==name&&delete wssh[name]}function log_status(text,to_populate){console.log(text),status.html(text.split("\n").join("<br/>")),to_populate&&validated_form_data&&(populate_form(validated_form_data),validated_form_data=void 0),"none"!==waiter.css("display")&&waiter.hide(),"none"===form_container.css("display")&&form_container.show()}function ajax_complete_callback(resp){if(button.prop("disabled",!1),200!==resp.status)return log_status(resp.status+": "+resp.statusText,!0),void(state=0);var msg=resp.responseJSON;if(!msg.id)return log_status(msg.status,!0),void(state=0);var ws_url=window.location.href.split(/\?|#/,1)[0].replace("http","ws"),join,url=ws_url+("/"===ws_url[ws_url.length-1]?"":"/")+"ws?id="+msg.id,sock=new window.WebSocket(url),encoding="utf-8",decoder=window.TextDecoder?new window.TextDecoder(encoding):encoding,terminal=document.getElementById("terminal"),termOptions={cursorBlink:!0,theme:{background:url_opts_data.bgcolor||"black",foreground:url_opts_data.fontcolor||"white"}};if(url_opts_data.fontsize){var fontsize=window.parseInt(url_opts_data.fontsize);fontsize&&fontsize>0&&(termOptions.fontSize=fontsize)}var term=new window.Terminal(termOptions);function term_write(text){term&&(term.write(text),term.resized||(resize_terminal(term),term.resized=!0))}function set_encoding(new_encoding){if(new_encoding)if(window.TextDecoder)try{decoder=new window.TextDecoder(new_encoding),encoding=decoder.encoding,console.log("Set encoding to "+encoding)}catch(RangeError){return console.log("Unknown encoding "+new_encoding),!1}else encoding=decoder=new_encoding,console.log("Set encoding to "+encoding);else console.log("An encoding is required")}term.fitAddon=new window.FitAddon.FitAddon,term.loadAddon(term.fitAddon),console.log(url),msg.encoding?console.log("The deault encoding of your server is "+msg.encoding):(console.log("Unable to detect the default encoding of your server"),msg.encoding=encoding),wssh.set_encoding=set_encoding,url_opts_data.encoding?!1===set_encoding(url_opts_data.encoding)&&set_encoding(msg.encoding):set_encoding(msg.encoding),wssh.geometry=function(){var geometry=current_geometry(term);console.log("Current window geometry: "+JSON.stringify(geometry))},wssh.send=function(data){if(sock)if("string"==typeof data)try{JSON.parse(data),sock.send(data)}catch(SyntaxError){data=data.trim()+"\r",sock.send(JSON.stringify({data:data}))}else console.log("Only string is allowed");else console.log("Websocket was already closed")},wssh.reset_encoding=function(){encoding===msg.encoding?console.log("Already reset to "+msg.encoding):set_encoding(msg.encoding)},wssh.resize=function(cols,rows){if(void 0!==term){var valid_args=!1;if(cols>0&&rows>0){var geometry=current_geometry(term);cols<=geometry.cols&&rows<=geometry.rows&&(valid_args=!0)}valid_args?term.on_resize(cols,rows):console.log("Unable to resize terminal to geometry: "+format_geometry(cols,rows))}else console.log("Terminal was already destroryed")},wssh.set_bgcolor=function(color){set_backgound_color(term,color)},wssh.set_fontcolor=function(color){set_font_color(term,color)},wssh.custom_font=function(){update_font_family(term)},wssh.default_font=function(){reset_font_family(term)},term.on_resize=function(cols,rows){cols===this.cols&&rows===this.rows||(console.log("Resizing terminal to geometry: "+format_geometry(cols,rows)),this.resize(cols,rows),sock.send(JSON.stringify({resize:[cols,rows]})))},term.onData((function(data){sock.send(JSON.stringify({data:data}))})),sock.onopen=function(){term.open(terminal),toggle_fullscreen(term),update_font_family(term),term.focus(),state=2,title_element.text=url_opts_data.title||default_title,url_opts_data.command&&setTimeout((function(){sock.send(JSON.stringify({data:url_opts_data.command+"\r"}))}),500)},sock.onmessage=function(msg){read_file_as_text(msg.data,term_write,decoder)},sock.onerror=function(e){console.error(e)},sock.onclose=function(e){term.dispose(),term=void 0,sock=void 0,reset_wssh(),log_status(e.reason,!0),state=0,default_title="WebSSH",title_element.text=default_title},$(window).resize((function(){term&&resize_terminal(term)}))}function wrap_object(opts){var obj={get:function(attr){return opts[attr]||""},set:function(attr,val){opts[attr]=val}};return obj}function clean_data(data){var i,attr,val,attrs=form_keys.concat(["privatekey","passphrase"]);for(i=0;i<attrs.length;i++)attr=attrs[i],"string"==typeof(val=data.get(attr))&&data.set(attr,val.trim())}function validate_form_data(data){clean_data(data);var hostname=data.get("hostname"),port=data.get("port"),username=data.get("username"),pk=data.get("privatekey"),result={valid:!1,data:data,title:""},errors=[],size;return hostname?hostname_tester.test(hostname)||errors.push("Invalid hostname: "+hostname):errors.push("Value of hostname is required."),port?port>0&&port<=65535||errors.push("Invalid port: "+port):port=22,username||errors.push("Value of username is required."),pk&&(size=pk.size||pk.length)>16384&&errors.push("Invalid private key: "+pk.name||""),errors.length&&!debug||(result.valid=!0,result.title=username+"@"+hostname+":"+port),result.errors=errors,result}function disable_file_inputs(inputs){var i,input;for(i=0;i<inputs.length;i++)0===(input=inputs[i]).files.length&&input.setAttribute("disabled","")}function enable_file_inputs(inputs){var i;for(i=0;i<inputs.length;i++)inputs[i].removeAttribute("disabled")}function connect_without_options(){var form=document.querySelector(form_id),inputs=form.querySelectorAll('input[type="file"]'),url=form.action,data,pk;function ajax_post(){status.text(""),button.prop("disabled",!0),$.ajax({url:url,type:"post",data:data,complete:ajax_complete_callback,cache:!1,contentType:!1,processData:!1})}disable_file_inputs(inputs),data=new FormData(form),pk=data.get("privatekey"),enable_file_inputs(inputs);var result=validate_form_data(data);if(result.valid)return pk&&pk.size&&!debug?read_file_as_text(pk,(function(text){void 0===text?log_status("Invalid private key: "+pk.name):ajax_post()})):ajax_post(),result;log_status(result.errors.join("\n"))}function connect_with_options(data){var form=document.querySelector(form_id),url=data.url||form.action,_xsrf=form.querySelector('input[name="_xsrf"]'),result=validate_form_data(wrap_object(data));if(result.valid)return data.term=term_type.val(),data._xsrf=_xsrf.value,event_origin&&(data._origin=event_origin),status.text(""),button.prop("disabled",!0),$.ajax({url:url,type:"post",data:data,complete:ajax_complete_callback}),result;log_status(result.errors.join("\n"))}function connect(hostname,port,username,password,privatekey,passphrase,totp){var result,opts;0===state?(result=void 0===hostname?connect_without_options():connect_with_options(opts="string"==typeof hostname?{hostname:hostname,port:port,username:username,password:password,privatekey:privatekey,passphrase:passphrase,totp:totp}:hostname))&&(state=1,default_title=result.title,hostname&&(validated_form_data=result.data),store_items(fields,result.data)):console.log(messages[state])}function cross_origin_connect(event){console.log(event.origin);var prop="connect",args;try{args=JSON.parse(event.data)}catch(SyntaxError){args=event.data.split("|")}Array.isArray(args)||(args=[args]);try{event_origin=event.origin,wssh[prop].apply(wssh,args)}finally{event_origin=void 0}}wssh.connect=connect,$(form_id).submit((function(event){event.preventDefault(),connect()})),document.fonts&&document.fonts.ready.then((function(){!1===custom_font_is_loaded()&&(document.body.style.fontFamily=custom_font.family)})),parse_url_data(decode_uri_component(window.location.search.substring(1))+"&"+decode_uri_component(window.location.hash.substring(1)),form_keys,opts_keys,url_form_data,url_opts_data),url_opts_data.term&&term_type.val(url_opts_data.term),null===url_form_data.password?log_status("Password via url must be encoded in base64."):get_object_length(url_form_data)?(waiter.show(),connect(url_form_data)):(restore_items(fields),form_container.show())}));
